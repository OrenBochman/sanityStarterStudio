{"version":3,"sources":["../../src/lib/performSeoReview.js"],"names":["performSeoReview","url","keyword","synonyms","previewUrl","URL","searchParams","append","fetch","toString","credentials","then","res","text","html","parser","DOMParser","htmlDocument","parseFromString","dataContent","querySelector","innerHTML","fallbackContent","content","title","innerText","description","getAttribute","canonicalUrl","resPreviewUrl","permalink","origin","pathname","options","titleWidth","paper","Paper","researcher","Researcher","i18n","Jed","domain","locale_data","hiddenTests","assessmentResults","Object","keys","assessments","reduce","parentAcc","parentKey","childAcc","childKey","includes","CurrentAssessment","hasOwnProperty","getResult","assessmentConfig","config","fleschReading","newAssessment","resultsArray","parentCur","newArr","newChild","resultsMapped","forEach","key","length","meta","catch","err","error","message"],"mappings":"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","sourcesContent":["import Jed from 'jed'\nimport {Researcher, Paper, assessments} from 'yoastseo'\nimport config from 'yoastseo/src/config/content/default.js'\n\nimport mapResults from './mapResults'\n\nexport default async function performSeoReview(url, keyword, synonyms) {\n  const previewUrl = new URL(url)\n\n  // Tell the API route to just fetch and return the HTML string\n  previewUrl.searchParams.append(`fetch`, `true`)\n\n  // We fetch the /api/preview route to enable us to examine draft/unpublished content\n  // The addition of a &fetch=true searchParam will make the API route perform a fetch request\n  // Returning an object which contains the absoluteUrl of final page and its HTML as a string\n  return fetch(previewUrl.toString(), {credentials: `include`})\n    .then((res) => res.text())\n    .then((html) => {\n      const parser = new DOMParser()\n      const htmlDocument = parser.parseFromString(html, `text/html`)\n\n      // Check for the existence of our expected data-content identifier\n      const dataContent = htmlDocument.querySelector(`[data-content=\"main\"]`)?.innerHTML\n      const fallbackContent = htmlDocument.querySelector(`main`)?.innerHTML\n      const content = dataContent ?? fallbackContent\n\n      const title = htmlDocument.querySelector(`title`)?.innerText\n      const description = htmlDocument\n        .querySelector(`meta[name=description]`)\n        ?.getAttribute(`content`)\n\n      const canonicalUrl = htmlDocument.querySelector('[rel=\"canonical\"]')?.getAttribute('href')\n      const resPreviewUrl = canonicalUrl ? new URL(canonicalUrl) : {}\n\n      // This key is for the absolute URL\n      const permalink = resPreviewUrl?.origin + resPreviewUrl?.pathname\n\n      // Confusingly, this key is just the pathname\n      const url = resPreviewUrl?.pathname\n      \n      const options = {\n        keyword: keyword ?? ``,\n        synonyms: synonyms ?? ``,\n        url: url ?? ``,\n        permalink: permalink ?? ``,\n        title,\n        // TODO: Could not find where/how Yoast measures this\n        titleWidth: 600, \n        description,\n        // TODO: Not yet configurable\n        // locale: langCulture.replace('-', '_'),\n      }\n\n      const paper = new Paper(content, options)\n      const researcher = new Researcher(paper)\n      const i18n = new Jed({\n        domain: 'js-text-analysis',\n        // eslint-disable-next-line camelcase\n        locale_data: {\n          'js-text-analysis': {\n            '': {},\n          },\n        },\n      })\n\n      const hiddenTests = [`UrlLengthAssessment`, `TaxonomyTextLengthAssessment`]\n\n      // Parent keys are \"seo\" and \"readability\"\n      // Some assessments are objects, some are functions\n      const assessmentResults = Object.keys(assessments).reduce((parentAcc, parentKey) => {\n        // Inside each key are the tests\n        parentAcc[parentKey] = Object.keys(assessments[parentKey]).reduce((childAcc, childKey) => {\n          // Some assessments have been depreciated\n          if (hiddenTests.includes(childKey)) {\n            // console.log(`Hidden:`, childKey)\n            return childAcc\n          }\n\n          const CurrentAssessment = assessments[parentKey][childKey]\n\n          // But not all of them are objects with the `getResult` function\n          if (\n            typeof CurrentAssessment === `object` &&\n            CurrentAssessment.hasOwnProperty(`getResult`)\n          ) {\n            childAcc[childKey] = CurrentAssessment.getResult(paper, researcher, i18n)\n          } else if (typeof CurrentAssessment === `function`) {\n            let assessmentConfig = {}\n\n            switch (childKey) {\n              case 'FleschReadingEaseAssessment':\n                assessmentConfig = config.fleschReading\n                break\n              default:\n                break\n            }\n\n            const newAssessment = new CurrentAssessment(assessmentConfig)\n            childAcc[childKey] = newAssessment.getResult(paper, researcher, i18n)\n          } else {\n            // console.log(`Skipped:`, childKey, thisAssessment)\n            childAcc[childKey] = {text: `Test Skipped`}\n          }\n\n          return childAcc\n        }, {})\n\n        return parentAcc\n      }, {})\n\n      // Now reduce these tests down to a flattened array\n      const resultsArray = Object.keys(assessmentResults).reduce((parentAcc, parentCur) => {\n        const newArr = Object.keys(assessmentResults[parentCur]).reduce((childAcc, childKey) => {\n          const newChild = assessmentResults[parentCur][childKey]\n\n          return newChild ? [...childAcc, newChild] : childAcc\n        }, [])\n\n        return newArr ? [...parentAcc, ...newArr] : parentAcc\n      }, [])\n\n      // mapResults function is a lightly edited function copied from the Yoast WordPress plugin\n      // It adds more details to each score\n      // https://github.com/Yoast/wordpress-seo/blob/0742e9b6ba4c0d6ae9d65223267a106b92a6a4a1/js/src/components/contentAnalysis/mapResults.js\n      const resultsMapped = mapResults(resultsArray)\n\n      // Finally, remove any empty keys\n      Object.keys(resultsMapped).forEach((key) => {\n        if (!resultsMapped[key].length) {\n          delete resultsMapped[key]\n        }\n      })\n\n      return {\n        permalink,\n        meta: {\n          title,\n          description,\n        },\n        resultsMapped,\n      }\n    })\n    .catch((err) => ({\n      error: err.message,\n    }))\n}\n"],"file":"performSeoReview.js"}